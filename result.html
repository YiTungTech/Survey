<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/js.cookie.js"></script>
    <script src="js/html2canvas.js"></script>
    <script src="js/formula.js"></script>
    <script type="text/javascript">
    var gFormID = '1FAIpQLSf61A3kcoDVT929bta3X01AMaz4ieTDYwL2Ehz9FoHVuaIVnw'; //google 表單ID [for test CopyDown + Gmerge 版本 (Responses)]
    var gSheetParam = {}; //google sheet所需要的參數

    $(function() {
        console.log('start()');
        var config; //json格式的config設定檔
        var qmconfig; //json格式的question mapping設定檔
        initConfig();


        //-----解析gSheetRequestParam-----
        //1. 提供method取得gSheetRequestParam參數
        //2. 組合出google sheet url
        $.extend({
            getUrlVars: function() {
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                var vars = [],
                    hash; //目前不清楚vars型別是什麼?怎麼使用?
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                    //動態宣告gSheetParam物件的Object
                    gSheetParam['entry.' + hash[0]] = decodeURIComponent(hash[1]);
                }
                return vars;
            },
            getUrlVar: function(name) {
                //回傳http get參數
                var result = $.getUrlVars()[name];
                return typeof result != 'undefined' ? result : '2';
            }
        });


        function initConfig() {
            console.log('initConfig()');
            // 讀取config檔案
            $.ajax({
                cache: false,
                url: "config/config.json",
                dataType: "json",
                success: function(data) {
                    config = data;
                    initQuestionMapping();
                }
            });
        }

        function initQuestionMapping() {
            console.log('initQuestionMapping()');
            // 讀取config檔案
            $.ajax({
                cache: false,
                url: "config/qmconfig.json",
                dataType: "json",
                success: function(data) {
                    // console.log('initQuestionMapping() success');
                    qmconfig = data;
                    updateConfig();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                }

            });
        }


        //將user的分數塞入config檔案
        function updateConfig() {
            console.log('updateConfig()');
            $.each(config.session, function(i, item_session) {
                //跑完所有question
                $.each(item_session.question, function(j, item_question) {

                    // console.log('getUrlVar='+$.getUrlVar(item_question.qid));
                    // item_question.value = $.getUrlVar(item_question.qid); // json object set value

                    //todo 問題還沒建立完成，所以部分item_question.qid會拿到空的qid
                    var qid = $.getUrlVar(item_question.qid);
                    if (typeof qid != 'undefined') {
                        item_question.value = $.getUrlVar(item_question.qid); // json object set value    
                    } else {
                        item_question.value = '4'; //set default
                    }
                });
            });
            // console.log('config=' + JSON.stringify(config));
            calculate();
        }


        //計算data
        function calculate() {
            console.log('calculate()');
            var A = calculate_A(config, qmconfig);
            var B_typeA = calculate_B_typeA(qmconfig);
            var B_typeB = calculate_B_typeB(qmconfig);
            var C = calculate_C(qmconfig);
            var D = calculate_D(qmconfig);

            updateUI(B_typeA);
            updateUI_B_typeB(B_typeB);
            updateUI_C(C);
            updateUI_A(A);
            updateUI_D(D);

        }

        //update UI

        function updateUI_A(A) {
            $.each(A, function(index, data) {
                var outputTitle = '#ui_A_' + (index + 1) + '_1';
                var outputDetail = '#ui_A_' + (index + 1) + '_2';
                var title = A[index].title;
                var detail = A[index].detail;
                $(outputTitle).append(title);
                $(outputDetail).append(detail);
            });
        }

        function updateUI(B_typeA) {
            $.each($('.ui_B_1'), function(index, data) {
                var data_B_1 = B_typeA[0];
                if ((index >= data_B_1.length)) return; //超過長度
                //todo 之後title跟detail要分開
                $(this).append(data_B_1[index].title + ' <p> ' + data_B_1[index].detail + '</p');
            });

            $.each($('.ui_B_2'), function(index, data) {
                var data_B_2 = B_typeA[1];
                if ((index >= data_B_2.length)) return;
                //todo 之後title跟detail要分開
                $(this).append(data_B_2[index].title + ' <p> ' + data_B_2[index].detail + '</p');

            });
        }

        function updateUI_B_typeB(B_typeB) {
            $.each($('.ui_B_3'), function(index, data) {
                var data_B_3 = B_typeB[0];
                if ((index >= data_B_3.length)) return; //超過長度
                //todo 之後title跟detail要分開
                $(this).append(data_B_3[index].title + ' <p> ' + data_B_3[index].detail + '</p');
            });

            $.each($('.ui_B_4'), function(index, data) {
                var ui_B_4 = B_typeB[1];
                if ((index >= ui_B_4.length)) return; //超過長度
                //todo 之後title跟detail要分開
                $(this).append(ui_B_4[index].title + ' <p> ' + ui_B_4[index].detail + '</p');
            });

            //todo UI沒有顯示出B-5-1：
            $.each($('.ui_B_5'), function(index, data) {
                var ui_B_5 = B_typeB[2];
                if ((index >= ui_B_5.length)) return; //超過長度
                //todo 之後title跟detail要分開
                $(this).append(ui_B_5[index].title + ' <p> ' + ui_B_5[index].detail + '</p');
            });

        }


        function updateUI_C(C) {
            $.each($('.ui_C_1'), function(index, data) {
                var data_C = C[0];
                if ((index >= data_C.length)) return; //超過長度
                //todo 之後title跟detail要分開
                $(this).append(data_C[index].title + ' <p> ' + data_C[index].detail + '</p');
            });

            $.each($('.ui_C_2'), function(index, data) {
                var data_C = C[1];
                if ((index >= data_C.length)) return; //超過長度
                //todo 之後title跟detail要分開
                $(this).append(data_C[index].title + ' <p> ' + data_C[index].detail + '</p');
            });

        }

        function updateUI_D(D) {
            $('#ui_D_1').append(D.title);
            $('#ui_D_2').append(D.detail);
        }

        //todo: 截圖功能先不用在這裡寫 (demo已經有寫了)


    });

    //send gooogle sheet request
    function gSheetRequestParam() {

        console.log('gSheetParam=' + JSON.stringify(gSheetParam));
        $.ajax({
            url: 'https://docs.google.com/forms/d/e/' + gFormID + '/formResponse',
            data: gSheetParam,
            type: "POST",
            dataType: "xml",
            statusCode: {
                0: function() {
                    console.log('Success message');
                },
                200: function() {
                    console.log('Success message');
                }
            }
        });
    }

    //將html轉換成canvas
    function callCanvas() {
        console.log("callCanvas");
        html2canvas(document.body).then(function(canvas) {
            console.log("html2canvas");
            // document.body.appendChild(canvas);
            getCanvas = canvas;

            var imgageData = canvas.toDataURL("image/png");
            // Now browser starts downloading it instead of just showing it
            var newData = imgageData.replace(/^data:image\/png/, "data:application/octet-stream");
            $("#downloadimage").attr("download", "your_pic_name.png").attr("href", newData);
        });
    }
    </script>
</head>

<body>
    <p id="version">version 2</p>
    <p id="ui_A_1_1">A-1-1供：</p>
    <p id="ui_A_1_2">A-1-2供評：</p>
    <p id="ui_A_2_1">A-2-1耗：</p>
    <p id="ui_A_2_2">A-2-2耗評：</p>
    <p id="ui_A_3_1">A-3-1熱：</p>
    <p id="ui_A_3_2">A-3-2熱評：</p>
    <p id="ui_A_4_1">A-4-1濕：</p>
    <p id="ui_A_4_2">A-4-2濕評：</p>
    <p id="ui_A_5_1">A-5-1寒：</p>
    <p id="ui_A_5_2">A-5-2寒評：</p>
    <p id="ui_D_1">D-1總：</p>
    <p id="ui_D_2">D-2總評：</p>
    <br>
    <p>----------------------</p>
    <p class="ui_B_1">B-1-1：</p>
    <p class="ui_B_1">B-1-2：</p>
    <p class="ui_B_1">B-1-3：</p>
    <p>----------------------</p>
    <p class="ui_B_2">B-2-1：</p>
    <p class="ui_B_2">B-2-2：</p>
    <p class="ui_B_2">B-2-3：</p>
    <p>----------------------</p>
    <p class="ui_B_3">B-3-1：</p>
    <p class="ui_B_3">B-3-2：</p>
    <p class="ui_B_3">B-3-3：</p>
    <p>----------------------</p>
    <p class="ui_B_4">B-4-1：</p>
    <p class="ui_B_4">B-4-2：</p>
    <p class="ui_B_4">B-4-3：</p>
    <p>----------------------</p>
    <p class="ui_B_5">B-5-1：</p>
    <p class="ui_B_5">B-5-2：</p>
    <p class="ui_B_5">B-5-3：</p>
    <p>----------------------</p>
    <p class="ui_C_1">C-1-1：</p>
    <p class="ui_C_1">C-1-2：</p>
    <p class="ui_C_1">C-1-3：</p>
    <p>----------------------</p>
    <p class="ui_C_2">C-2-1：</p>
    <p class="ui_C_2">C-2-2：</p>
    <p class="ui_C_2">C-2-3：</p>
    <p>----------------------</p>
    <a id="back" href="contact.html">聯絡我</a>
    <a id="back" href="qu.html">重新填問卷</a>
    <a id="downloadimage" href="#">Download</a>
</body>

</html>