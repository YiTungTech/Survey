<!doctype html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="js/js.cookie.js"></script>
    <script src="js/html2canvas.js"></script>
    <script type="text/javascript">
    var gFormID = '1FAIpQLSf61A3kcoDVT929bta3X01AMaz4ieTDYwL2Ehz9FoHVuaIVnw'; //google 表單ID [for test CopyDown + Gmerge 版本 (Responses)]
    var gSheetParam = {}; //google sheet所需要的參數

    $(function() {

        console.log('start()');
        var config; //json格式的config設定檔
        var qmconfig; //json格式的question mapping設定檔
        initConfig();


        //-----解析gSheetRequestParam-----
        //1. 提供method取得gSheetRequestParam參數
        //2. 組合出google sheet url
        $.extend({
            getUrlVars: function() {
                var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
                var vars = [],
                    hash; //目前不清楚vars型別是什麼?怎麼使用?
                for (var i = 0; i < hashes.length; i++) {
                    hash = hashes[i].split('=');
                    vars.push(hash[0]);
                    vars[hash[0]] = hash[1];
                    //動態宣告gSheetParam物件的Object
                    gSheetParam['entry.' + hash[0]] = decodeURIComponent(hash[1]);
                }
                return vars;
            },
            getUrlVar: function(name) {
                //回傳http get參數
                return $.getUrlVars()[name];
            }
        });


        function initConfig() {
            console.log('initConfig()');
            // 讀取config檔案
            $.ajax({
                cache: false,
                url: "config/config.json",
                dataType: "json",
                success: function(data) {
                    config = data;
                    initQuestionMapping();
                }
            });
        }

        function initQuestionMapping() {
            console.log('initQuestionMapping()');
            // 讀取config檔案
            $.ajax({
                cache: false,
                url: "config/qmconfig.json",
                dataType: "json",
                success: function(data) {
                    // console.log('initQuestionMapping() success');
                    qmconfig = data;
                    updateConfig();
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    console.log(textStatus, errorThrown);
                }

            });
        }


        //將user的分數塞入config檔案
        function updateConfig() {
            console.log('updateConfig()');
            $.each(config.session, function(i, item_session) {
                //跑完所有question
                $.each(item_session.question, function(j, item_question) {
                    item_question.value = $.getUrlVar(item_question.qid); // json object set value

                });
            });
            // console.log('config=' + JSON.stringify(config));
            calculate();
        }


        //計算data
        function calculate() {
            console.log('calculate()');
            calculateSingleAverage_Type();
            calculateAdvisement_life();
            calculateAdvisement();

            //send request to google sheet
            // gSheetRequestParam();   //todo: 測試先不送request
        }

        //計算
        //1. -----Type_0_4-----0.4總
        //2. -----Type_1_1-----1.1供
        //3. -----Type_1_2-----1.2供評
        var uiValue = []; //要呈現在UI，各項「分數」
        function calculateSingleAverage_Type() {
            console.log('calculateSingleAverage_Type()');
            var uiWording = []; //要呈現在UI，各項「wording」
            var uiTotalValue; //要呈現在UI，總「分數」
            var tempSumTotalValue = 0; //計算過程中暫存，將5大類分數累加
            var tempTotalValues = [];

            $.each(config.session, function(i, item_session) {
                var valueArray = []; //所有的值
                var sumValue = 0; //加總
                $.each(item_session.question, function(j, item_question) {
                    var score = valueToScore(parseInt(item_question.value));
                    sumValue += score;
                    valueArray.push(score);
                });

                //最大值
                var valueMax = Math.max.apply(null, valueArray);
                // console.log('Type_1_1_' + i + '_最大值=' + valueMax);

                //平均值
                var valueAverage = sumValue / item_session.question.length;
                // console.log('Type_1_1_' + i + '_平均值=' + valueAverage);

                //1.綜合平均值 2.取4捨5入到小數第1位
                var temp = (valueMax + valueAverage) / 2;
                // console.log('temp=' + temp);
                tempSumTotalValue += temp;
                tempTotalValues.push(temp);
                uiValue.push(Math.round(temp * 10) / 10);




            });

            // console.log('uiValue=' + uiValue.toString());

            //mapping文字
            $.each(uiValue, function(i, value) {
                uiWording.push(ScoreToWording_Type_1_1(i, uiValue[i]));
            });
            // console.log('uiWording=' + uiWording.toString());

            //-----換算成「總」Type_0_4 -----
            var tempValueMax = Math.max.apply(null, tempTotalValues);
            var tempValueAverage = (tempSumTotalValue / config.session.length);
            //1.綜合平均值 2.取4捨5入到小數第1位
            uiTotalValue = (tempValueMax + tempValueAverage) / 2;
            uiTotalValue = Math.round(uiTotalValue * 10) / 10;
            // console.log('uiTotalValue=' + uiTotalValue);
            //-----換算成「總」Type_0_4 -----

            //-----update UI-----
            $.each(uiValue, function(i, value) {
                $('#Type_1_1_' + i).append(value);
            });

            $.each(uiWording, function(i, value) {
                $('#Type_1_2_' + i).append(value);
            });

            $('#Type_1_0_4').append(uiTotalValue);
            //-----update UI-----


        }

        //(模組)分算換算
        function valueToScore(value) {
            switch (value) {
                case 1:
                    return 0;
                case 2:
                    return 2.5;
                case 3:
                    return 5;
                case 4:
                    return 7.5;
                case 5:
                    return 10;
            }
        }

        //取得wording ----- Type_1_1 ----- 1.2供評
        function ScoreToWording_Type_1_1(session, value) {
            if (session == 0) {
                if (2 >= value) { return "您沒有供氧能力不足的現象。"; }
                if (4 >= value && value > 2) { return "輕度供氧能力不足。"; }
                if (7 >= value && value > 4) { return "供氧能力不佳，容易發生缺氧。"; }
                if (10 >= value && value > 7) { return "嚴重的供氧障礙，經常性缺氧。"; }
            }
            if (session == 1) {
                if (2 >= value) { return "您沒有能量透支的現象。"; }
                if (4 >= value && value > 2) { return "輕度能量透支。"; }
                if (7 >= value && value > 4) { return "中度能量透支，消耗器官儲備。"; }
                if (10 >= value && value > 7) { return "嚴重能量透支，易形成缺氧病灶。"; }
            }

        }

        //計算
        //1. -----format_B----- 1.9供?建
        function calculateAdvisement_life() {
            console.log('calculateAdvisement_life()');
            //todo 取得mapping question

            var uiAdvisementArray = [];
            var uiSingleAdvisementArray = [];

            //todo 取出分數>5的題目，放到陣列

            $.each(qmconfig.format_B_type1.session, function(i, item_session) {

                uiSingleAdvisementArray = [];
                //是否需要使用「運動處方」
                var isNeedExercise = uiValue[i] > qmconfig.format_B_type1.compareFormulaA;

                $.each(item_session.question, function(j, item_question) {
                    var score = parseInt($.getUrlVar(item_question.qid));
                    score = valueToScore(score);
                    // console.log('item_question score=' + score); 


                    if (score > qmconfig.format_B_type1.compare) {
                        //符合條件，加入陣列
                        uiSingleAdvisementArray.push(item_question);
                    }
                });

                // console.log('排序前=' + JSON.stringify(uiSingleAdvisementArray));
                // 排序
                //【建議排序規則一】依照各題填答結果換算出的分數高低，由高至低排序。
                //【建議排序規則二】同分時，依照各建議優先順序設定排序。(參考表3欄位「生活排序規則2」)
                uiSingleAdvisementArray.sort(function(a, b) {
                    function cmp(x, y) {
                        return x > y ? 1 : (x < y ? -1 : 0); //等於的時候不要動
                    }
                    var scoreA = valueToScore(parseInt($.getUrlVar(a.qid)));
                    var scoreB = valueToScore(parseInt($.getUrlVar(b.qid)));
                    return cmp(scoreB, scoreA) || cmp(a.sort, b.sort); //return score是第一條件，sort為第2條件
                });

                // console.log('排序後=' + JSON.stringify(uiSingleAdvisementArray));

                if (isNeedExercise) {
                    //todo 計算運動處方
                }

                //符合條件的object
                // console.log('uiSingleAdvisementArray='+JSON.stringify(uiSingleAdvisementArray));



            });




            //todo sort

            //判斷是否使用運動處方，取得供指數 > 2，則使用

            //取出項目

        }

        //計算
        //1. -----Type_1_10----- 1.10供運?
        function calculateAdvisement() {
            console.log('calculateAdvisement()');
            //todo: 要可填入供2建、供3建....耗1建...
            var advisementGIDGroup = ['1848259859', '1221090849', '299261106']; //填入ID
            var uiAdvisement = '';
            for (var i = advisementGIDGroup.length - 1; i >= 0; i--) {
                var score = valueToScore(parseInt($.getUrlVar(advisementGIDGroup[i])));
                if (score >= 5) {
                    uiAdvisement = "顯示供1建ＷＯＲＤＩＮＧ";
                    break;
                }

            }

            //-----update UI-----
            if (uiAdvisement.length > 0) {
                $("#Type_1_10_1").append(uiAdvisement);
            }
            //-----update UI-----



        }

        //todo: 截圖功能先不用在這裡寫 (demo已經有寫了)


    });

    //send gooogle sheet request
    function gSheetRequestParam() {

        console.log('gSheetParam=' + JSON.stringify(gSheetParam));
        $.ajax({
            url: 'https://docs.google.com/forms/d/e/' + gFormID + '/formResponse',
            data: gSheetParam,
            type: "POST",
            dataType: "xml",
            statusCode: {
                0: function() {
                    console.log('Success message');
                },
                200: function() {
                    console.log('Success message');
                }
            }
        });
    }

    //將html轉換成canvas
    function callCanvas() {
        console.log("callCanvas");
        html2canvas(document.body).then(function(canvas) {
            console.log("html2canvas");
            // document.body.appendChild(canvas);
            getCanvas = canvas;

            var imgageData = canvas.toDataURL("image/png");
            // Now browser starts downloading it instead of just showing it
            var newData = imgageData.replace(/^data:image\/png/, "data:application/octet-stream");
            $("#downloadimage").attr("download", "your_pic_name.png").attr("href", newData);
        });
    }
    </script>
</head>

<body>
    <p id="version">version 2</p>
    <p id="Type_1_0_4">總：</p>
    <p id="Type_1_1_0">供：</p>
    <p id="Type_1_2_0">供評：</p>
    <br>
    <p id="Type_1_1_1">耗：</p>
    <p id="Type_1_2_1">耗評：</p>
    <br>
    <p>----------------------</p>
    <p id="Type_1_10_1">供1建：</p>
    <a id="back" href="qu.html">重新填問卷</a>
    <a id="downloadimage" href="#">Download</a>
</body>

</html>